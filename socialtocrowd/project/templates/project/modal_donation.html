{% load i18n %}

<!-- modal_donation -->
<div class="modal fade" id="modal_donation" tabindex="-1" role="dialog" aria-labelledby="modal_donationLabel" aria-hidden="true">
    <div class="modal-dialog">
        <!-- modal-content form -->
        <div class="modal-content form active">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans "Close" %}</span></button>
                <h3 class="modal-title" id="myModalLabel">{% trans "Donate thing" %}</h3>
            </div>
            <div class="modal-body">

                <!-- form -->
                <form>
                    <!-- form-section -->
                    <div class="form-section">
                        <h4 class="form-section-header"><span class="badge">1</span>{% trans "Have you a object photo? Upload it!" %}</h4>
                        <div class="well text-center">
                            <i class="icon-camera i-64"></i>
                            <p>
                                <input type="file" id="img" class="file_upload" accept="image/*"/>
                                <!-- a href="#" id="btn_img" class="black">{% trans "Add image" %}</a -->
                            </p>

                        </div>
                    </div>
                    <!-- END form-section -->
                    <!-- form-section -->
                    <div class="form-section">
                        <h4 class="form-section-header"><span class="badge">2</span>{% trans "Add name and description of the object" %}</h4>
                        <div class="form-group">
                            <select class="form-control" id="object_id">
                                <option>--- {% trans "Object name" %} ---</option>
                                {% for thing in project.things.all %}
                                    {% if thing.ndonations.nodonate > 0 %}
                                        <option value="{{ thing.id }}">
                                        {{ thing.name }}: {{ thing.ndonations.nodonate }} {% trans "remaining" %}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <input id="object_quantity" type="number" min="0" max="90"
                                class="form-control" placeholder="{% trans "Object quantity" %}">
                            </input>
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="objectDrescription">{% trans "Object description" %}</label>
                            <textarea class="form-control" id="object_info" placeholder="{% trans "Object description" %}"></textarea>
                        </div>
                        <div class="checkbox">
                            <label><input id="priv" type="checkbox">{% trans "Private donation" %}</label>
                        </div>
                    </div>
                    <!-- END form-section -->
                    <!-- form-section -->
                    <div class="form-section">
                        <h4 class="form-section-header"><span class="badge">3</span>{% trans "Select shipping" %}</h4>
                        <select class="form-control" id="ship">
                            {% for dir in project.directions.all %}
                                <option value="{{ dir.id }}">{{ dir }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- END form-section -->

                    <!-- cart -->
                    <div id="cart" class="form-section">
                        <h4 class="form-section-header"><span class="badge">Â·</span>{% trans "Donation cart" %}</h4>
                        <ul></ul>
                    </div>
                    <!-- END cart -->
                </form>
                <!-- END form -->

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" onclick="add()">{% trans "Add" %}</button>
                <button type="button" class="btn btn-primary" onclick="addFinish()">{% trans "Add and donate" %}</button>
                <button type="button" class="btn btn-primary" onclick="finish()">{% trans "Donate" %}</button>
            </div>
        </div>
        <!-- END modal-content form -->
        <!-- modal-content success -->
        <div class="modal-content success">
            <div class="modal-header">
                <button type="button" onclick="formModalReset();" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans "Close" %}</span></button>
            </div>
            <div class="modal-body text-center">
                <i class="icon-checkmark i-128"></i>
                <h3>{% trans "Done!" %}</h3>
                <h4>{% trans "Thank for you collaboration" %}</h4>
            </div>
        </div>
        <!-- END modal-content success-->
    </div>
</div>
<!-- END modal_donation -->

<script type="text/javascript">
    $("#modal_donation").on('shown', refresh());

    function donation(add, close) {
        if(add) {
            var select_id = document.getElementById("object_id");
            var obj_id = select_id.options[select_id.selectedIndex].value;
            if (obj_id == '')
                return false;
            var obj_quantity = document.getElementById("object_quantity").value;
            if (obj_quantity == '')
                return false;
            var select_ship = document.getElementById("ship");
            var ship = select_ship.options[select_ship.selectedIndex].value;
            if (ship == '')
                return false;
        }

        var project_slug = "{{ project.slug }}";
        var priv = document.getElementById("priv").checked;
        var img = document.getElementById("img").value;
        var obj_info = document.getElementById("object_info").value;

        $.ajax({
            type: 'POST',
            url: '/project/donate/' + project_slug + '/',
            data: {
                'csrfmiddlewaretoken': $.cookie('csrftoken'),
                'img': img,
                'thing_id': obj_id,
                'quantity': obj_quantity,
                'info': obj_info,
                'priv': priv,
                'ship': ship,
                'add': add,
                'close': close,
            },
            success: function(json) {
                if(!json.error) {
                    if (!close) {
                        refresh_cart(json['ship']);
                    } else {
                        formModalSuccess();
                    }
                }
            }
        });
    };

    function removeDonation(id) {
        $.ajax({
            type: 'GET',
            url: '/project/donate/remove/' + id + '/',
            data: {},
            success: function(json) {
                if(!json.error) {
                    refresh_cart(json['ship']);
                }
            }
        });
    };

    function refresh() {
        donation(false, false);
    }

    function finish() {
        donation(false, true);
    };

    function add() {
        donation(true, false);
    };

    function addFinish() {
        donation(true, true);
    };

    function refresh_cart(ship) {
        $("#cart ul li").remove();
        for (don in ship.donations) {
            var name = ship.donations[don].thing.name;
            var quantity = ship.donations[don].quantity;
            var don_id = ship.donations[don].id;
            $("#cart ul").append(
                '<li>' + name + ' x ' + quantity +
                '<a href="#" clickable="true" onclick=removeDonation(' + don_id + ')> Remove</a></li>'
            );
        }
    }
</script>
